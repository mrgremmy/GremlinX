import { ClassDeclaration, DeclarationStatement, FunctionDeclaration, InterfaceDeclaration, NamedTypeNode, Source, TypeName, TypeNode, util, } from "@btc-vision/assemblyscript/dist/assemblyscript.js";
import { ASTBuilder } from "./astBuilder.js";
import cloneDeep from "lodash.clonedeep";
// const cloneDeep: <T>(t: T) => T = require("lodash.clonedeep") as any;
export function decorates(node, name) {
    return node.name.text === name;
}
export function isDecorator(name) {
    return (node) => decorates(node, name);
}
export function hasDecorator(node, name) {
    let decl;
    if (node instanceof DeclarationStatement) {
        decl = node;
    }
    else {
        decl = node.declaration;
    }
    // because it could be undefined
    return decl.decorators?.some(isDecorator(name)) == true;
}
export function getDecorator(node, name) {
    return node.decorators?.find(isDecorator(name));
}
export function isLibrary(node) {
    return node.isLibrary || node.internalPath.startsWith("~lib/rt/");
}
export function not(fn) {
    return (t) => !fn(t);
}
export function toString(node) {
    return ASTBuilder.build(node);
}
const OR_NULL = /\|.*null/;
export function getName(node) {
    if (node instanceof TypeNode) {
        if (node instanceof NamedTypeNode) {
            let name = getTypeName(node.name);
            const typeParameters = node.typeArguments;
            if (typeParameters && typeParameters.length > 0) {
                name += `<${typeParameters.map(getName).join(", ")}>`;
            }
            if (node.isNullable && !OR_NULL.test(name)) {
                name = `${name} | null`;
            }
            return name;
        }
        else if (node instanceof TypeName) {
            return toString(node.identifier);
        }
        return "";
    }
    if (node instanceof ClassDeclaration || node instanceof InterfaceDeclaration || node instanceof FunctionDeclaration) {
        return className(node);
    }
    return toString(node.name);
}
export function getTypeName(node) {
    const partNames = [];
    let currentNode = node;
    while (currentNode) {
        partNames.push(toString(currentNode.identifier));
        currentNode = currentNode.next;
    }
    return partNames.join(".");
}
export function cloneNode(node) {
    return cloneDeep(node);
}
export function isUserEntry(node) {
    return node.range.source.sourceKind == 1 /* SourceKind.UserEntry */;
}
export function isEntry(node) {
    return isUserEntry(node) || node.range.source.sourceKind == 3 /* SourceKind.LibraryEntry */;
}
export function className(_class) {
    let name = toString(_class.name);
    const typeParameters = _class.typeParameters;
    if (typeParameters) {
        name += `<${typeParameters.map(getName).join(", ")}>`;
    }
    return name;
}
export function isMethodNamed(name) {
    return (stmt) => stmt.kind == 58 /* NodeKind.MethodDeclaration */ && toString(stmt.name) === name;
}
export function updateSource(program, newSource) {
    const sources = program.sources;
    for (let i = 0, len = sources.length; i < len; i++) {
        if (sources[i].internalPath == newSource.internalPath) {
            sources[i] = newSource;
            break;
        }
    }
}
export class StringBuilder {
    sb = [];
    get last() {
        return this.sb[this.sb.length - 1];
    }
    push(s) {
        this.sb.push(s);
    }
    finish(separator = "\n") {
        let res = this.sb.join(separator);
        this.sb = [];
        return res;
    }
}
/**
 *
 * @param emitter DiagnosticEmitter
 * @returns return true if emitter have ERROR message
 */
export function hasErrorMessage(emitter) {
    return hasMessage(emitter, 3 /* DiagnosticCategory.Error */);
}
/**
 *
 * @param emitter DiagnosticEmitter
 * @returns return true if emitter have WARNING message
 */
export function hasWarningMessage(emitter) {
    return hasMessage(emitter, 2 /* DiagnosticCategory.Warning */);
}
/**
 *
 * @param emitter DiagnosticEmitter
 * @returns return true if emitter have `category` message
 */
export function hasMessage(emitter, category) {
    const diagnostics = emitter.diagnostics ? emitter.diagnostics : [];
    for (const msg of diagnostics) {
        if (msg.category === category) {
            return true;
        }
    }
    return false;
}
let isStdlibRegex = /\~lib\/(?:array|arraybuffer|atomics|builtins|crypto|console|compat|dataview|date|diagnostics|error|function|iterator|map|math|number|object|process|reference|regexp|set|staticarray|string|symbol|table|typedarray|vector|rt\/?|bindings\/|shared\/typeinfo)|util\/|uri|polyfills|memory/;
export function isStdlib(s) {
    let source = s instanceof Source ? s : s.range.source;
    return isStdlibRegex.test(source.internalPath);
}
export const indent = util.indent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILGdCQUFnQixFQUNoQixvQkFBb0IsRUFJcEIsbUJBQW1CLEVBRW5CLG9CQUFvQixFQUNwQixhQUFhLEVBS2IsTUFBTSxFQUVOLFFBQVEsRUFDUixRQUFRLEVBQ1IsSUFBSSxHQUNQLE1BQU0sbURBQW1ELENBQUM7QUFDM0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sU0FBUyxNQUFNLGtCQUFrQixDQUFDO0FBRXpDLHdFQUF3RTtBQUV4RSxNQUFNLFVBQVUsU0FBUyxDQUFDLElBQW1CLEVBQUUsSUFBWTtJQUN2RCxPQUE4QixJQUFJLENBQUMsSUFBSyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUM7QUFDM0QsQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQUMsSUFBWTtJQUNwQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzNDLENBQUM7QUFHRCxNQUFNLFVBQVUsWUFBWSxDQUN4QixJQUFrRSxFQUNsRSxJQUFZO0lBRVosSUFBSSxJQUFJLENBQUM7SUFDVCxJQUFJLElBQUksWUFBWSxvQkFBb0IsRUFBRSxDQUFDO1FBQ3ZDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDaEIsQ0FBQztTQUFNLENBQUM7UUFDSixJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUM1QixDQUFDO0lBQ0QsZ0NBQWdDO0lBQ2hDLE9BQU8sSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDO0FBQzVELENBQUM7QUFFRCxNQUFNLFVBQVUsWUFBWSxDQUN4QixJQUEwQixFQUMxQixJQUFZO0lBRVosT0FBTyxJQUFJLENBQUMs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LENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFDdEQsT0FBTyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNuRCxDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgQ2xhc3NEZWNsYXJhdGlvbixcclxuICAgIERlY2xhcmF0aW9uU3RhdGVtZW50LFxyXG4gICAgRGVjb3JhdG9yTm9kZSxcclxuICAgIERpYWdub3N0aWNDYXRlZ29yeSxcclxuICAgIERpYWdub3N0aWNFbWl0dGVyLFxyXG4gICAgRnVuY3Rpb25EZWNsYXJhdGlvbixcclxuICAgIElkZW50aWZpZXJFeHByZXNzaW9uLFxyXG4gICAgSW50ZXJmYWNlRGVjbGFyYXRpb24sXHJcbiAgICBOYW1lZFR5cGVOb2RlLFxyXG4gICAgTm9kZSxcclxuICAgIE5vZGVLaW5kLFxyXG4gICAgUHJvZ3JhbSxcclxuICAgIFJhbmdlLFxyXG4gICAgU291cmNlLFxyXG4gICAgU291cmNlS2luZCxcclxuICAgIFR5cGVOYW1lLFxyXG4gICAgVHlwZU5vZGUsXHJcbiAgICB1dGlsLFxyXG59IGZyb20gXCJAYnRjLXZpc2lvbi9hc3NlbWJseXNjcmlwdC9kaXN0L2Fzc2VtYmx5c2NyaXB0LmpzXCI7XHJcbmltcG9ydCB7IEFTVEJ1aWxkZXIgfSBmcm9tIFwiLi9hc3RCdWlsZGVyLmpzXCI7XHJcbmltcG9ydCBjbG9uZURlZXAgZnJvbSBcImxvZGFzaC5jbG9uZWRlZXBcIjtcclxuXHJcbi8vIGNvbnN0IGNsb25lRGVlcDogPFQ+KHQ6IFQpID0+IFQgPSByZXF1aXJlKFwibG9kYXNoLmNsb25lZGVlcFwiKSBhcyBhbnk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZGVjb3JhdGVzKG5vZGU6IERlY29yYXRvck5vZGUsIG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICg8SWRlbnRpZmllckV4cHJlc3Npb24+bm9kZS5uYW1lKS50ZXh0ID09PSBuYW1lO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNEZWNvcmF0b3IobmFtZTogc3RyaW5nKTogKG5vZGU6IERlY29yYXRvck5vZGUpID0+IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIChub2RlKSA9PiBkZWNvcmF0ZXMobm9kZSwgbmFtZSk7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaGFzRGVjb3JhdG9yKFxyXG4gICAgbm9kZTogRGVjbGFyYXRpb25TdGF0ZW1lbnQgfCB7IGRlY2xhcmF0aW9uOiBEZWNsYXJhdGlvblN0YXRlbWVudCB9LFxyXG4gICAgbmFtZTogc3RyaW5nXHJcbik6IGJvb2xlYW4ge1xyXG4gICAgbGV0IGRlY2w7XHJcbiAgICBpZiAobm9kZSBpbnN0YW5jZW9mIERlY2xhcmF0aW9uU3RhdGVtZW50KSB7XHJcbiAgICAgICAgZGVjbCA9IG5vZGU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRlY2wgPSBub2RlLmRlY2xhcmF0aW9uO1xyXG4gICAgfVxyXG4gICAgLy8gYmVjYXVzZSBpdCBjb3VsZCBiZSB1bmRlZmluZWRcclxuICAgIHJldHVybiBkZWNsLmRlY29yYXRvcnM/LnNvbWUoaXNEZWNvcmF0b3IobmFtZSkpID09IHRydWU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREZWNvcmF0b3IoXHJcbiAgICBub2RlOiBEZWNsYXJhdGlvblN0YXRlbWVudCxcclxuICAgIG5hbWU6IHN0cmluZ1xyXG4pOiBEZWNvcmF0b3JOb2RlIHtcclxuICAgIHJldHVybiBub2RlLmRlY29yYXRvcnM/LmZpbmQoaXNEZWNvcmF0b3IobmFtZSkpITtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTGlicmFyeShub2RlOiBTb3VyY2UpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBub2RlLmlzTGlicmFyeSB8fCBub2RlLmludGVybmFsUGF0aC5zdGFydHNXaXRoKFwifmxpYi9ydC9cIik7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBub3Q8VD4oZm46ICh0OiBUKSA9PiBib29sZWFuKTogKHQ6IFQpID0+IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICh0OiBUKSA9PiAhZm4odCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0b1N0cmluZyhub2RlOiBOb2RlKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBBU1RCdWlsZGVyLmJ1aWxkKG5vZGUpO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgTmFtZWQge1xyXG4gICAgbmFtZTogSWRlbnRpZmllckV4cHJlc3Npb247XHJcbn1cclxuXHJcbmNvbnN0IE9SX05VTEwgPSAvXFx8LipudWxsLztcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmFtZShub2RlOiBOb2RlICYgTmFtZWQgfCBUeXBlTm9kZSk6IHN0cmluZyB7XHJcbiAgICBpZiAobm9kZSBpbnN0YW5jZW9mIFR5cGVOb2RlKSB7XHJcbiAgICAgICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBOYW1lZFR5cGVOb2RlKSB7XHJcbiAgICAgICAgICAgIGxldCBuYW1lID0gZ2V0VHlwZU5hbWUobm9kZS5uYW1lKVxyXG4gICAgICAgICAgICBjb25zdCB0eXBlUGFyYW1ldGVycyA9IG5vZGUudHlwZUFyZ3VtZW50cztcclxuICAgICAgICAgICAgaWYgKHR5cGVQYXJhbWV0ZXJzICYmIHR5cGVQYXJhbWV0ZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIG5hbWUgKz0gYDwke3R5cGVQYXJhbWV0ZXJzLm1hcChnZXROYW1lKS5qb2luKFwiLCBcIil9PmA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG5vZGUuaXNOdWxsYWJsZSAmJiAhT1JfTlVMTC50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICBuYW1lID0gYCR7bmFtZX0gfCBudWxsYDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbmFtZVxyXG4gICAgICAgIH0gZWxzZSBpZiAobm9kZSBpbnN0YW5jZW9mIFR5cGVOYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0b1N0cmluZyhub2RlLmlkZW50aWZpZXIpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgfVxyXG4gICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBDbGFzc0RlY2xhcmF0aW9uIHx8IG5vZGUgaW5zdGFuY2VvZiBJbnRlcmZhY2VEZWNsYXJhdGlvbiB8fCBub2RlIGluc3RhbmNlb2YgRnVuY3Rpb25EZWNsYXJhdGlvbikge1xyXG4gICAgICAgIHJldHVybiBjbGFzc05hbWUobm9kZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdG9TdHJpbmcobm9kZS5uYW1lKTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRUeXBlTmFtZShub2RlOiBUeXBlTmFtZSk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBwYXJ0TmFtZXMgPSBbXTtcclxuICAgIGxldCBjdXJyZW50Tm9kZTogVHlwZU5hbWUgfCBudWxsID0gbm9kZTtcclxuICAgIHdoaWxlIChjdXJyZW50Tm9kZSkge1xyXG4gICAgICAgIHBhcnROYW1lcy5wdXNoKHRvU3RyaW5nKGN1cnJlbnROb2RlLmlkZW50aWZpZXIpKTtcclxuICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLm5leHQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGFydE5hbWVzLmpvaW4oXCIuXCIpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xvbmVOb2RlPFQgZXh0ZW5kcyBOb2RlPihub2RlOiBUKTogVCB7XHJcbiAgICByZXR1cm4gY2xvbmVEZWVwKG5vZGUpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNVc2VyRW50cnkobm9kZTogTm9kZSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIG5vZGUucmFuZ2Uuc291cmNlLnNvdXJjZUtpbmQgPT0gU291cmNlS2luZC5Vc2VyRW50cnk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0VudHJ5KG5vZGU6IE5vZGUpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBpc1VzZXJFbnRyeShub2RlKSB8fCBub2RlLnJhbmdlLnNvdXJjZS5zb3VyY2VLaW5kID09IFNvdXJjZUtpbmQuTGlicmFyeUVudHJ5O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xhc3NOYW1lKF9jbGFzczogQ2xhc3NEZWNsYXJhdGlvbiB8IEludGVyZmFjZURlY2xhcmF0aW9uIHwgRnVuY3Rpb25EZWNsYXJhdGlvbik6IHN0cmluZyB7XHJcbiAgICBsZXQgbmFtZSA9IHRvU3RyaW5nKF9jbGFzcy5uYW1lKVxyXG4gICAgY29uc3QgdHlwZVBhcmFtZXRlcnMgPSBfY2xhc3MudHlwZVBhcmFtZXRlcnM7XHJcbiAgICBpZiAodHlwZVBhcmFtZXRlcnMpIHtcclxuICAgICAgICBuYW1lICs9IGA8JHt0eXBlUGFyYW1ldGVycy5tYXAoZ2V0TmFtZSkuam9pbihcIiwgXCIpfT5gO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5hbWU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc01ldGhvZE5hbWVkKG5hbWU6IHN0cmluZyk6IChfOiBEZWNsYXJhdGlvblN0YXRlbWVudCkgPT4gYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gKHN0bXQ6IERlY2xhcmF0aW9uU3RhdGVtZW50KSA9PiBzdG10LmtpbmQgPT0gTm9kZUtpbmQuTWV0aG9kRGVjbGFyYXRpb24gJiYgdG9TdHJpbmcoc3RtdC5uYW1lKSA9PT0gbmFtZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVNvdXJjZShwcm9ncmFtOiBQcm9ncmFtLCBuZXdTb3VyY2U6IFNvdXJjZSkge1xyXG4gICAgY29uc3Qgc291cmNlcyA9IHByb2dyYW0uc291cmNlcztcclxuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBzb3VyY2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgaWYgKHNvdXJjZXNbaV0uaW50ZXJuYWxQYXRoID09IG5ld1NvdXJjZS5pbnRlcm5hbFBhdGgpIHtcclxuICAgICAgICAgICAgc291cmNlc1tpXSA9IG5ld1NvdXJjZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU3RyaW5nQnVpbGRlciB7XHJcbiAgICBwcml2YXRlIHNiOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIGdldCBsYXN0KCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2JbdGhpcy5zYi5sZW5ndGggLSAxXVxyXG4gICAgfVxyXG5cclxuICAgIHB1c2goczogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zYi5wdXNoKHMpO1xyXG4gICAgfVxyXG5cclxuICAgIGZpbmlzaChzZXBhcmF0b3IgPSBcIlxcblwiKTogc3RyaW5nIHtcclxuICAgICAgICBsZXQgcmVzID0gdGhpcy5zYi5qb2luKHNlcGFyYXRvcik7XHJcbiAgICAgICAgdGhpcy5zYiA9IFtdO1xyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKlxyXG4gKiBAcGFyYW0gZW1pdHRlciBEaWFnbm9zdGljRW1pdHRlclxyXG4gKiBAcmV0dXJucyByZXR1cm4gdHJ1ZSBpZiBlbWl0dGVyIGhhdmUgRVJST1IgbWVzc2FnZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGhhc0Vycm9yTWVzc2FnZShlbWl0dGVyOiBEaWFnbm9zdGljRW1pdHRlcik6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGhhc01lc3NhZ2UoZW1pdHRlciwgRGlhZ25vc3RpY0NhdGVnb3J5LkVycm9yKTtcclxufVxyXG5cclxuLyoqXHJcbiAqXHJcbiAqIEBwYXJhbSBlbWl0dGVyIERpYWdub3N0aWNFbWl0dGVyXHJcbiAqIEByZXR1cm5zIHJldHVybiB0cnVlIGlmIGVtaXR0ZXIgaGF2ZSBXQVJOSU5HIG1lc3NhZ2VcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBoYXNXYXJuaW5nTWVzc2FnZShlbWl0dGVyOiBEaWFnbm9zdGljRW1pdHRlcik6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGhhc01lc3NhZ2UoZW1pdHRlciwgRGlhZ25vc3RpY0NhdGVnb3J5Lldhcm5pbmcpO1xyXG59XHJcblxyXG4vKipcclxuICpcclxuICogQHBhcmFtIGVtaXR0ZXIgRGlhZ25vc3RpY0VtaXR0ZXJcclxuICogQHJldHVybnMgcmV0dXJuIHRydWUgaWYgZW1pdHRlciBoYXZlIGBjYXRlZ29yeWAgbWVzc2FnZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGhhc01lc3NhZ2UoXHJcbiAgICBlbWl0dGVyOiBEaWFnbm9zdGljRW1pdHRlcixcclxuICAgIGNhdGVnb3J5OiBEaWFnbm9zdGljQ2F0ZWdvcnlcclxuKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBkaWFnbm9zdGljcyA9IGVtaXR0ZXIuZGlhZ25vc3RpY3MgPyBlbWl0dGVyLmRpYWdub3N0aWNzIDogW107XHJcbiAgICBmb3IgKGNvbnN0IG1zZyBvZiBkaWFnbm9zdGljcykge1xyXG4gICAgICAgIGlmIChtc2cuY2F0ZWdvcnkgPT09IGNhdGVnb3J5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuXHJcbmxldCBpc1N0ZGxpYlJlZ2V4ID1cclxuICAgIC9cXH5saWJcXC8oPzphcnJheXxhcnJheWJ1ZmZlcnxhdG9taWNzfGJ1aWx0aW5zfGNyeXB0b3xjb25zb2xlfGNvbXBhdHxkYXRhdmlld3xkYXRlfGRpYWdub3N0aWNzfGVycm9yfGZ1bmN0aW9ufGl0ZXJhdG9yfG1hcHxtYXRofG51bWJlcnxvYmplY3R8cHJvY2Vzc3xyZWZlcmVuY2V8cmVnZXhwfHNldHxzdGF0aWNhcnJheXxzdHJpbmd8c3ltYm9sfHRhYmxlfHR5cGVkYXJyYXl8dmVjdG9yfHJ0XFwvP3xiaW5kaW5nc1xcL3xzaGFyZWRcXC90eXBlaW5mbyl8dXRpbFxcL3x1cml8cG9seWZpbGxzfG1lbW9yeS87XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNTdGRsaWIoczogU291cmNlIHwgeyByYW5nZTogUmFuZ2UgfSk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHNvdXJjZSA9IHMgaW5zdGFuY2VvZiBTb3VyY2UgPyBzIDogcy5yYW5nZS5zb3VyY2U7XHJcbiAgICByZXR1cm4gaXNTdGRsaWJSZWdleC50ZXN0KHNvdXJjZS5pbnRlcm5hbFBhdGgpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgaW5kZW50ID0gdXRpbC5pbmRlbnQ7XHJcbiJdfQ==